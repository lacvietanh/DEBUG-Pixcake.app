{"version":3,"sources":["webpack:///./src/qt-ipc/constant.ts","webpack:///./src/mixins/tsFileImport.ts","webpack:///./src/views/BatchRetouch/ImportImageView.vue","webpack:///src/views/BatchRetouch/ImportImageView.vue","webpack:///./src/views/BatchRetouch/ImportImageView.vue?79b6","webpack:///./src/views/BatchRetouch/ImportImageView.vue?fc73","webpack:///./src/views/BatchRetouch/components/ImportProgressDialog.vue","webpack:///src/views/BatchRetouch/components/ImportProgressDialog.vue","webpack:///./src/views/BatchRetouch/components/ImportProgressDialog.vue?200f","webpack:///./src/views/BatchRetouch/components/ImportProgressDialog.vue?9a43","webpack:///./src/views/BatchRetouch/ImportImageView.vue?8e14","webpack:///./src/views/BatchRetouch/components/ImportProgressDialog.vue?0356","webpack:///./src/views/BatchRetouch/components/ImportProgressDialog.vue?8234","webpack:///./src/composables/points/useHomeItemPointsRepositories.ts"],"names":["FsConstant","PermissionRetCode","OK","NO_Read_Write","NO_Read","NO_Write","Path_Length_Overflow","kImportConfirmDialog","Vue","extend","mixins","toast","pointsMixin","components","ImportProgressDialog","data","dropPaths","stopImageImport","isMakeSureImport","showImportProgress","importProgress","needDeleteImportProject","dbThumbAbortImportFinished","importIdMaps","Map","importIds","deleteRequestMap","isAppend","curProjectId","onHandlerProgress","onHandlerFinished","myImportName","bIsCancelImport","computed","mapGetters","methods","mapActions","mapMutations","resetHandleCallback","this","onManualImportClick","filePaths","checkAndImportImages","thumbnailCount","importImageRpc","handleAfterMenuManualImport","tsNotify","message","progress","status","ImportProgressStatus","Start","getDropPaths","window","$dragFiles","cancel","console","log","setCancelImportState","Date","CancelImport","_SetCancelImport","filePath","length","result","isDir","ret","overflow","i","fPath","WIN_MAX_PATH","isFile","fs","statSync","accessSync","constants","R_OK","hasRead","hasWrite","W_OK","app","isWin","isLargeThanWin10Version","project","tsFilePathUtils","getProjectRootPathByProject","FileUtils","deleteFolder","e","error","supportedExtendNames","ImageExtendNames","checkCanImport","type","toastNoReadWritePermission","fileDes","permissions","statImportDetail","imgFiles","totalNum","jpgNum","rawNum","item","imgFormat","PointCakeImport","callBack","isOnline","$net","activeProject","innerCheckAndImportImages","importImagesOnHome","removeProject","projectId","_RemoveProject","selectProjects","delete","addConfirmDialogListener","isAdd","dialogIpc","addListener","FConfirmDialogKey","param","tsConfirm","then","async","replyDialogConfirm","catch","removeListener","addImportImageListener","SignalCloseProgressDialogKey","SignalImportProgressKey","over","total","SignalImportFinishedKey","addCounts","SignalUpdateProjectKey","albumbPaths","importTimes","thumbnailNumber","ACT_AsyncUpdateProject","id","path","thumbnailPaths","onUpdateProjectResult","SignalRemoveStoreProjectKey","nProjectId","SignalRootNameKey","rootName","mounted","beforeDestroy","reset","render","_vm","_c","_self","staticClass","attrs","on","$event","preventDefault","stopPropagation","onDropHanlder","apply","arguments","$platform","onAddClick","require","_v","$isDev","$isBeta","style","width","model","value","inputImportDir","callback","$$v","expression","marginLeft","onConfirmImportClick","_e","handleCancelImport","nativeOn","staticRenderFns","name","tsFileImport","isShowingImportDialog","watch","processImport","that","query","properties","paths","component","_setupProxy","visible","_s","percentage","showCancelBtn","canShowCancelBtn","onCancelClick","process","props","default","importFilePaths","importName","setup","PointHomeItem","loading","loadingTimer","uploadPercent","isCancel","hasImportDbStatus","filters","strPrefix","strMsg","formatMessage","begin","handler","immediate","clearTimeout","delay","strHome","foundKey","foundItem","groupMap","firstDirPath","isFound","retName","calcTextPixLen","ele","document","autoAddPercentage","useHomeItemPointsRepositories","sendPoint","useBaseRepositories","operate","PointEvent","CakeWorkBench","cake_operate","PointClickProject","itemCount","cake_number"],"mappings":"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kB9C,EAAG,YAAY,CAACE,YAAY,cAAcC,MAAM,CAAC,KAAO,iBAAiBC,GAAG,CAAC,MAAQL,EAAIgD,iBAAiBhD,EAAI4B,MAAM,QAEpzBG,EAAkB,G,wHC4CtB,MAAM1C,EAAO,OAAQA,KACf4D,EAAU,EAAQ,QAET,mCAAgB,CAC/BjB,8BACA9K,gBACAG,YACA,mBACA,6BAGA6L,OACA7B,OACAhF,aACA8G,YAEA1J,QACA4C,YACA8G,sBAEA5L,MACA8E,YACA8G,gBAIAC,iBACA/G,WACA8G,YACA,IAGAL,eACAzG,aACA8G,YAEAE,YACAhH,YACA8G,aAGAG,QACA,oBAAAC,GAAA,iBAEA,OACAA,kBAGAhM,OACA,OACAiM,WACAb,mBACAc,kBACAC,gBACAC,YACAZ,oBACAa,uBAGAC,WACApL,aACA,kCAEA,4BACA,iBAEAc,UACA,sBACA,YACA,mBACA,uBACA,2BACA,yBAEA,WACA,iBACA,KACA,yBACA,yBACA,MACA,cACA,KACA,qBACAuK,QACA,+BACA,OACA,MAGA9B,gBAEA,kBAQA,OAPA,IACA+B,wBAEA,6DACAA,kBAGA,GAEAC,iBACA,UAEAnB,aACA,SACA,iBACA,wBACA,yBACA,wBACA,8BAGA,+DACA,WAAAlE,QAAAC,GAAA,UACA,0BACA,SAEA,gBACA,kBAGA,OADA5E,iDACA,EAGA,+BACA,sBACA,WAAA2E,QAAAC,GAAA,UACA,MAEA,OADAqF,kBACA,qBACA,oCACA,4BACA,mCACA,WAAAtF,QAAAC,GAAA,UACA,MACA,yBAEA,2BAIAuD,OACAd,OACA6C,WACA,gBAEAC,cAEAxB,WACA,IACA,2BAEA,uBAEAlJ,UACA,0BACA,yBACA,2BAEA,SACAC,kBACAA,oBACAA,mBACAA,mBACAA,yBAEA,uBACA,0BAEA0K,gCACA,eACAC,wDACA,qBAMAzE,YAEAjH,YACA,mBACA,yBACAqB,kCACA,sDACA,uBACA,sCAEA,GACAsK,QACA,qBAEA,GACA,gBACA,gBACAA,GAGA,YACA,gBACA,kBACA,sBACA,OACA,iBACA,oBACAC,IACA,MAGA,MACA,eACA,IACAC,MAEAA,UACAC,WAGA,iBACA,GACA,4CACAA,YAIA,UAGA,OACA,SACA,WACA,WACAzC,wBACA,kBACA,iBACA,OACA,gBACA,oBACA,WACA,QACA,4BACA,aACA,SACA,MAEA0C,KAEA,SACA,iBACA,qBACAC,KACA,MAGA3C,WAGA,MACA,YAEA,0BAIA,OAHA,kBACA4C,KAEA,GAEAC,kBACA,QAEA,iCAaA,OAVAC,cAEAA,wBACAA,4BAGAC,mCAEAvK,gBACAuK,wCACA,GAEAC,oBAEA,GADAhL,iCACA,oEAIA,OAHAoK,gCACA,4BACApK,wCAGA,mDACA,iCACA,uEAIA,OAHAoK,gCACA,4BACApK,wCAGA,wBACA,sBACA,2BAEA,MAEAgJ,gBACA,mCACA,mCCnW4X,I,kCCSxXP,EAAY,eACd,EACA1C,EACAgC,GACA,EACA,KACA,WACA,MAIa,OAAAU,E,2CCpBf,W,oCCAA,W,oCCAA,W,kFCAA,8DAQc,SAAUwC,IACpB,MAAM,UAAEC,GAAcC,iBAEtB,SAAS5B,EAAc6B,GACnBF,EAAUG,OAAWC,cAAe,CAAEC,aAAcH,IAGxD,SAASI,EAAkBC,GACvBP,EAAUG,OAAWC,cAAe,CAAEC,aAAc,gBAAiBG,YAAaD,IAGtF,MAAO,CACHlC,gBACAiC,uB","file":"js/chunk-7e536582.bf41dd79.js","sourcesContent":["export enum FsConstant {\n    R_OK = 1 << 1,\n    W_OK = 1 << 2\n}\n","import fs from '@/qt-ipc/fs'\nimport Vue from 'vue'\nimport path from '@/qt-ipc/path'\n// @ts-ignore\nimport md5 from 'js-md5'\nimport ipcRenderer from '@/qt-ipc/Ipc-renderer'\n\n// @ts-ignore\nimport toast from '@/mixins/toast'\nimport { ImportProgressStatus, MaxImportDir } from '@/constants'\nimport { ImageExtendNames, ImageType } from '@/universal/types/constants'\n\nimport { mapActions, mapGetters, mapMutations } from 'vuex'\n\n// @ts-ignore\nimport { getFileExtenstionName, sortBy } from '@/utils/utils'\n// @ts-ignore\nimport tsFilePathUtils from '@/utils/tsFilePathUtils'\n// @ts-ignore\nimport FileUtils from '@/utils/FileUtils'\nimport DBIpcRender from '@/irender/DBIpcRender'\nimport { PALETTE_PRESETS_CFG_TABLE, THUMBNAIL_TABLE } from '@/universal/types/config'\nimport { FsConstant as constants } from '@/qt-ipc/constant'\nimport ImportProgressDialog from '@/views/BatchRetouch/components/ImportProgressDialog.vue'\n\n// import {TSQrc} from '#/utils/tsqrc/tsqrc'\nimport { Optional } from '@/types/index'\nimport IpcRendererAsync from '@/qt-ipc/Ipc-renderer'\nimport Project from '@/model/ProjectModel'\nimport pointsMixin from '@/mixins/pointsMixin'\n// @ts-ignore\nimport { batchDeleteProject } from '@/api/projectApi'\n// @ts-ignore\nimport { deleteThumbnailIds } from '@/api/thumbnailApi'\n// @ts-ignore\nimport { delay } from '@/universal/utils/common'\n// @ts-ignore\nimport { find as findOneProject } from '@/universal/datastore/projectDao'\nimport tsqrcInstance from '@/qt-ipc/pixcookengine'\nimport { EncryptType } from '@/qt-ipc/constants/common'\nimport importImageRpc, {\n    SignalCloseProgressDialogKey,\n    SignalImportFinishedKey,\n    SignalImportProgressKey,\n    SignalRemoveStoreProjectKey, SignalRootNameKey,\n    SignalUpdateProjectKey\n} from '@/qt-ipc/business/import-image'\n\nimport { dialogIpc, FConfirmDialogKey } from '@/qt-ipc/dialog/DialogIpcImpl'\nimport {app} from \"@/qt-ipc/app\";\nimport {WIN_MAX_PATH} from \"@/constants/constants\";\n\n// 1: 是有权限,0: 没有读写权限,-1:没有写权限 ,-2:没有读权限\nexport const PermissionRetCode = {\n    OK: 1, //具有读写权限\n    NO_Read_Write: 0,\n    NO_Read: -2,\n    NO_Write: -1,\n    Path_Length_Overflow:-3\n}\n\nconst kImportConfirmDialog = 'importConfirmDialog'\n\nexport default Vue.extend({\n    mixins: [toast, pointsMixin],\n    components: {\n        ImportProgressDialog\n    },\n    data() {\n        return {\n            dropPaths: [],\n            stopImageImport: false, // 停止图片导入\n            isMakeSureImport: false,// 点击继续导入按钮\n            showImportProgress: false,\n            importProgress: {},\n            // 非二次导入的其非点击按钮创建的，需要在出错时，删除\n            needDeleteImportProject: false,\n            dbThumbAbortImportFinished: false,\n            importIdMaps: new Map(),\n            importIds: [], //导入的id列表\n            // 后端删除接口的请求映射，用于控制并发删除云端数据，已经在删除了，就忽略\n            deleteRequestMap: new Map(),\n            isAppend: false,\n            curProjectId: null, //缓存当前被删除的工程id,用于清理云端的缩略图id\n            onHandlerProgress: null,//((progress: number, over: number, total: number)=> void),\n            onHandlerFinished: null,//((addCounts: number) => void)\n            myImportName:\"\",\n            // 仅在工作台导入的vue层使用,导入创建工程时使用\n            bIsCancelImport:false\n        }\n    },\n\n    computed: {\n        ...mapGetters([\n            'userId'\n        ]),\n\n        ...mapGetters('project', [\n            'activeProject'\n        ]),\n\n        ...mapGetters('thumbnail', [\n            'getThumbnails',\n            'cancelImport'\n        ])\n    },\n\n    methods: {\n        ...mapActions('thumbnail', [\n            'ACT_InsertThumbnail'\n        ]),\n        ...mapActions('project', [\n            'ACT_AsyncUpdateProject',\n            'ACT_DeleteResInProject',\n            'ACT_DeleteProject',\n            'ACT_DeleteResInProjectByThumbIds'\n        ]),\n        ...mapMutations('thumbnail', ['_SetThumbnails', '_AppendThumbnails']),\n        ...mapMutations('project', ['_RemoveProject']),\n        resetHandleCallback(){\n            this.onHandlerFinished = null\n            this.onHandlerProgress = null\n        },\n        onManualImportClick(filePaths:any){\n            this.checkAndImportImages(filePaths, true, (thumbnailCount:number) => {\n                importImageRpc.handleAfterMenuManualImport()\n                this.resetHandleCallback()\n                this.tsNotify({\n                    message: `已导入${thumbnailCount}张图片`\n                })\n            }, (progress:any) => {\n                if (progress.status === ImportProgressStatus.Start) {\n                    this.showImportProgress = true\n                }\n                this.importProgress = progress\n            })\n        },\n        getDropPaths() {\n            let dropPaths = window.$dragFiles\n            return dropPaths\n        },\n        // 点击取消导入的处理\n        async _SetCancelImport(cancel: boolean) {\n            console.log(`_SetCancelImport:`, cancel)\n            await importImageRpc.setCancelImportState(cancel)\n            this.bIsCancelImport = cancel\n        },\n        async handleCancelImport() {\n            //@ts-ignore\n            if (!this.importProgress.status){\n                this.showImportProgress = false\n            }\n            console.log(`handleCancelImport()`, new Date())\n            // @ts-ignore\n            // this.status = ImportProgressStatus.CancelImport\n            this.importProgress.status = ImportProgressStatus.CancelImport\n            // @ts-ignore\n            await this._SetCancelImport(true)\n        },\n        // 1: 是有权限,0: 没有读写权限,-1:没有写权限 ,-2:没有读权限\n        async hasReadWritePermission(filePath: Array<string>): Promise<{ result: number, isDir: boolean }> {\n            if (!filePath || filePath.length === 0) {\n                return { result: PermissionRetCode.NO_Read_Write, isDir: true }\n            }\n            let ret = PermissionRetCode.OK\n            let isDir = true\n            let overflow = false\n            for (let i = 0; i < filePath.length; i++) {\n                let result = true\n                let fPath = filePath[i]\n                overflow = fPath.length > WIN_MAX_PATH\n                // 是文件的则跳过去\n                const isFile = (await fs.statSync(fPath)).isFile()\n                // 要有读的权限\n                if (isFile) {\n                    result = await fs.accessSync(fPath, constants.R_OK)\n                    if (result) {\n                        continue\n                    } else {\n                        ret = PermissionRetCode.NO_Read\n                        isDir = false\n                        break\n                    }\n                } else {\n                    isDir = true\n                    let hasRead = true\n                    let hasWrite = true\n                    result = await fs.accessSync(fPath, constants.R_OK)\n                    if (!result) {\n                        hasRead = false\n                        ret = PermissionRetCode.NO_Read\n                    }\n                    result = await fs.accessSync(fPath, constants.W_OK)\n                    if (!result) {\n                        hasWrite = false\n                        ret = hasRead ? PermissionRetCode.NO_Write : PermissionRetCode.NO_Read_Write\n                    }\n                    if (!hasRead || !hasWrite) {\n                        break\n                    }\n                }\n            }\n            if (ret != PermissionRetCode.OK && app.isWin && !app.isLargeThanWin10Version && overflow){\n                ret = PermissionRetCode.Path_Length_Overflow\n            }\n            return { result: ret, isDir: isDir }\n        },\n\n        // 删除项目缓存\n        async deleteProjectCache(project: any) {\n            let filePath = await tsFilePathUtils.getProjectRootPathByProject(project)\n            try {\n                await FileUtils.deleteFolder(filePath)\n            } catch (e) {\n                console.error(e)\n            }\n        },\n\n        supportedExtendNames() {\n            return ImageExtendNames\n        },\n        checkCanImport(): boolean {\n            // @ts-ignore\n            if (this.showImportProgress) {\n                // @ts-ignore\n                this.tsNotify({\n                    type: 'error',\n                    message: '正在导入中，稍后再尝试'\n                })\n                return false\n            }\n            return true\n        },\n\n\n        toastNoReadWritePermission({ result, isDir }: { result: number, isDir: boolean }) {\n            const fileDes = isDir ? '文件夹' : '文件'\n            const permissions = {\n                [PermissionRetCode.NO_Read]: '读',\n                [PermissionRetCode.NO_Write]: '写',\n                [PermissionRetCode.NO_Read_Write]: '读写'\n            }\n            let message = `该${ fileDes }没有${ permissions[result] }权限`\n            if (result == PermissionRetCode.Path_Length_Overflow){\n                message = `该${ fileDes }路径太长了，不能支持`\n            }\n            // @ts-ignore\n            this.tsNotify({\n                type: 'error',\n                message: message\n            })\n        },\n\n        /*\n            统计导入图片的数量\n         */\n        statImportDetail(imgFiles: Array<{\n            imgPath: string,\n            imgFormat: number,\n            importParentPath: string\n        }>) {\n            let totalNum = imgFiles.length\n            let jpgNum = 0\n            let rawNum = 0\n            for (const item of imgFiles) {\n                if (item.imgFormat == 3) {\n                    rawNum++\n                } else {\n                    jpgNum++\n                }\n            }\n\n            // @ts-ignore\n            this.PointCakeImport(`${ totalNum }_j${ jpgNum }_r${ rawNum }`)\n        },\n\n        /**\n         * 检测导入\n         * @param filePaths\n         * @param isAppend 是否是追加模式的导入\n         * @param callBack\n         * @param progress\n         */\n        async checkAndImportImages(filePaths: any[], isAppend: boolean, callBack: any, progress?: any) {\n            // @ts-ignore\n            if (this.showImportProgress) {\n                // @ts-ignore\n                this.tsNotify({\n                    type: 'error',\n                    message: '正在导入中，稍后再尝试'\n                })\n                return\n            }\n            let isOnline = await window.$net.isOnline()\n            if (!isOnline) {\n                // @ts-ignore\n                this.tsNotify({\n                    type: 'error',\n                    message: '网络异常，请检查网络后再试'\n                })\n                return\n            }\n            this.onHandlerProgress = progress\n            this.onHandlerFinished = callBack\n            this.dropPaths = filePaths as any\n            this.isAppend = isAppend\n            const project = this.activeProject\n            await this.innerCheckAndImportImages(project, filePaths, isAppend, this.needDeleteImportProject, callBack)\n        },\n\n        /**\n         * HOME首页的调用此项\n         * @param filePaths\n         * @param isAppend 是否是追加模式的导入\n         * @param callBack\n         * @param progress\n         */\n        async importImagesOnHome(filePaths: any[], isAppend: boolean, callBack: any, progress?: any) {\n            // @ts-ignore\n            // if (this.showImportProgress) {\n            //     // @ts-ignore\n            //     this.tsNotify({\n            //         type: 'error',\n            //         message: '正在导入中，稍后再尝试'\n            //     })\n            //     return\n            // }\n            let isOnline = await window.$net.isOnline()\n            if (!isOnline) {\n                // @ts-ignore\n                this.tsNotify({\n                    type: 'error',\n                    message: '网络异常，请检查网络后再试'\n                })\n                return\n            }\n            this.onHandlerProgress = progress\n            this.onHandlerFinished = callBack\n            this.dropPaths = filePaths as any\n            this.isAppend = isAppend\n            const project = this.activeProject\n\n            this.showImportProgress = true;\n            await importImageRpc.importImagesOnHome(isAppend, project, filePaths, this.needDeleteImportProject)\n        },\n\n        /*\n            内部的导入方法\n         */\n        async innerCheckAndImportImages(project: any, dropPaths: any, isAppend: boolean, needDeleteImportProject: boolean, callBack: any) {\n            this.showImportProgress = true;\n            await importImageRpc.checkAndImportImages(this.activeProject, dropPaths, isAppend, needDeleteImportProject)\n        },\n\n        removeProject(projectId: number) {\n            this._RemoveProject(projectId)\n            //@ts-ignore\n            this.selectProjects.delete(projectId)\n        },\n        addConfirmDialogListener(isAdd: boolean) {\n            if (isAdd) {\n                dialogIpc.addListener(FConfirmDialogKey(kImportConfirmDialog), (param: any) => {\n                    this.tsConfirm(param).then(async _ => {\n                        await dialogIpc.replyDialogConfirm(true)\n                    })\n                        .catch(async e => {\n                            await dialogIpc.replyDialogConfirm(false)\n                        })\n                })\n            } else {\n                dialogIpc.removeListener(FConfirmDialogKey(kImportConfirmDialog))\n            }\n        },\n        addImportImageListener() {\n            importImageRpc.addListener(SignalCloseProgressDialogKey, () => {\n                this.showImportProgress = false\n            })\n            importImageRpc.addListener(SignalImportProgressKey, (progress: number, over: number, total: number) => {\n                if (this.onHandlerProgress) {\n                    //@ts-ignore\n                    this.onHandlerProgress({\n                        status: `${ progress }`,\n                        over: `${ over }`,\n                        total: `${ total }`\n                    })\n                }\n            })\n            importImageRpc.addListener(SignalImportFinishedKey, (addCounts: number) => {\n                this.showImportProgress = false\n                if (this.onHandlerFinished) {\n                    //@ts-ignore\n                    this.onHandlerFinished(addCounts)\n                }\n            })\n            importImageRpc.addListener(SignalUpdateProjectKey, (albumbPaths: any, importTimes: number, thumbnailNumber: number,isAppend:boolean) => {\n                this.ACT_AsyncUpdateProject({\n                    // 如果是首次导入(非追加模式),则是要更新filePaths到工程路径\n                    // @ts-ignore\n                    id: this.activeProject.id,\n                    path: isAppend ? this.activeProject.path : this.dropPaths,\n                    thumbnailPaths: albumbPaths,\n                    importTimes: importTimes,\n                    // @ts-ignore\n                    thumbnailNumber: thumbnailNumber\n                }).then(async (resolve) => {\n                    // debugger\n                    await this._SetCancelImport(false)\n                    // 判断数据库的是否更新成功\n                    await importImageRpc.onUpdateProjectResult(true)\n                }).catch(async e => {\n                    // debugger\n                    console.error(e)\n                    await this._SetCancelImport(false)\n                    await importImageRpc.onUpdateProjectResult(false)\n                })\n            })\n            importImageRpc.addListener(SignalRemoveStoreProjectKey, (nProjectId: number) => {\n                this.removeProject(nProjectId)\n            })\n            importImageRpc.addListener(SignalRootNameKey, (rootName: string) => {\n                this.myImportName = rootName\n            })\n        }\n    },\n    mounted() {\n        this.addImportImageListener()\n        this.addConfirmDialogListener(true)\n    },\n    beforeDestroy() {\n        importImageRpc.reset()\n        this.addConfirmDialogListener(false)\n    }\n})\n","var render = function render(){var _vm=this,_c=_vm._self._c;return _c('div',{staticClass:\"claImportRoot\",attrs:{\"element-loading-background\":\"rgba(0, 0, 0, 0.9)\"},on:{\"drop\":function($event){$event.preventDefault();$event.stopPropagation();return _vm.onDropHanlder.apply(null, arguments)},\"dragover\":function($event){$event.preventDefault();$event.stopPropagation();},\"dragenter\":function($event){$event.preventDefault();$event.stopPropagation();}}},[(_vm.$platform === 'win32')?[_c('div',{staticClass:\"win-btn-class\"},[_c('el-button',{staticClass:\"btn\",attrs:{\"type\":\"info\",\"size\":\"larger\"},on:{\"click\":function($event){return _vm.onAddClick(['openFile'])}}},[_c('div',{staticClass:\"content\"},[_c('img',{staticClass:\"img\",attrs:{\"src\":require('@/assets/icons/home_icon_import_image@3x.png')}}),_c('span',{staticClass:\"text c-text-regular\"},[_vm._v(\"导入图片\")])])]),_c('el-button',{staticClass:\"btn\",attrs:{\"type\":\"info\",\"size\":\"larger\"},on:{\"click\":function($event){return _vm.onAddClick(['openDirectory'])}}},[_c('div',{staticClass:\"content\"},[_c('img',{staticClass:\"img\",attrs:{\"src\":require('@/assets/icons/home_icon_import_file@3x.png')}}),_c('span',{staticClass:\"text c-text-regular\"},[_vm._v(\"导入文件夹\")])])])],1)]:[_c('div',{staticClass:\"claImportContent border-primary-style-hover\",on:{\"click\":function($event){return _vm.onAddClick(['openDirectory', 'openFile'])}}},[_c('el-button',{attrs:{\"icon\":\"el-icon-plus\",\"type\":\"text\"}})],1)],_c('span',{staticClass:\"claDes\"},[_vm._v(\"点击导入文件或将文件夹（图片）拖到此处\")]),(this.$isDev || this.$isBeta)?_c('div',{attrs:{\"id\":\"manualInput\"}},[_c('el-input',{style:({width:'300px'}),attrs:{\"clearable\":\"\",\"placeholder\":\"自动化测试导入\"},model:{value:(_vm.inputImportDir),callback:function ($$v) {_vm.inputImportDir=$$v},expression:\"inputImportDir\"}}),_c('el-button',{style:({marginLeft:'12px'}),attrs:{\"id\":\"confirmImport\"},on:{\"click\":_vm.onConfirmImportClick}},[_vm._v(\"确定\")])],1):_vm._e(),_c('importProgressDialog',{attrs:{\"status\":_vm.importProgress.status,\"data\":_vm.importProgress,\"importName\":_vm.myImportName},on:{\"onCancelled\":_vm.handleCancelImport},nativeOn:{\"mousedown\":function($event){$event.stopPropagation();}},model:{value:(_vm.showImportProgress),callback:function ($$v) {_vm.showImportProgress=$$v},expression:\"showImportProgress\"}})],2)\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\n    <div\n        class=\"claImportRoot\"\n        element-loading-background=\"rgba(0, 0, 0, 0.9)\"\n        @drop.prevent.stop=\"onDropHanlder\"\n        @dragover.prevent.stop @dragenter.prevent.stop>\n\n        <template v-if=\"$platform === 'win32'\">\n            <div class=\"win-btn-class\">\n                <el-button\n                    class=\"btn\"\n                    type=\"info\"\n                    size=\"larger\"\n                    @click=\"onAddClick(['openFile'])\">\n                    <div class=\"content\">\n                        <img class=\"img\" :src=\"require('@/assets/icons/home_icon_import_image@3x.png')\">\n                        <span class=\"text c-text-regular\">导入图片</span>\n                    </div>\n                </el-button>\n\n                <el-button\n                    class=\"btn\"\n                    type=\"info\"\n                    size=\"larger\"\n                    @click=\"onAddClick(['openDirectory'])\">\n                    <div class=\"content\">\n                        <img class=\"img\" :src=\"require('@/assets/icons/home_icon_import_file@3x.png')\">\n                        <span class=\"text c-text-regular\">导入文件夹</span>\n                    </div>\n                </el-button>\n            </div>\n        </template>\n\n        <template v-else>\n            <div\n                class=\"claImportContent border-primary-style-hover\"\n                @click=\"onAddClick(['openDirectory', 'openFile'])\">\n                <el-button\n                    icon=\"el-icon-plus\"\n                    type=\"text\">\n                </el-button>\n            </div>\n        </template>\n\n        <span class=\"claDes\">点击导入文件或将文件夹（图片）拖到此处</span>\n\n        <div id=\"manualInput\" v-if=\"this.$isDev || this.$isBeta\">\n            <el-input clearable v-model=\"inputImportDir\" placeholder=\"自动化测试导入\" :style=\"{width:'300px'}\">\n            </el-input>\n            <el-button id=\"confirmImport\" :style=\"{marginLeft:'12px'}\" @click=\"onConfirmImportClick\">确定</el-button>\n        </div>\n\n\n        <importProgressDialog\n            @mousedown.native.stop\n            :status=\"importProgress.status\"\n            :data=\"importProgress\"\n            v-model=\"showImportProgress\"\n            :importName=\"myImportName\"\n            @onCancelled=\"handleCancelImport\"\n        >\n        </importProgressDialog>\n    </div>\n</template>\n\n<script>\nimport { mapGetters, mapActions, mapMutations } from 'vuex'\nimport toast from '@/mixins/toast'\nimport tsFileImport from '@/mixins/tsFileImport'\n\nimport { BatchActiveMode } from '@/constants/batchRetouchDef'\nimport { ImportProgressStatus } from '@/constants'\nimport fs from '@/qt-ipc/fs'\nimport {dialogIpc} from \"qt/dialog/DialogIpcImpl\";\nimport { debounce } from 'lodash'\n\nexport default {\n    name: 'ImportImageView.vue',\n    mixins: [toast,\n        tsFileImport\n    ],\n    data() {\n        return {\n            showImportProgress: false,\n            importProgress: {},\n            //自动化测试导入\n            inputImportDir: null,\n\t\t\t//是否是正在显示导入对话框\n\t\t\tisShowingImportDialog:false\n        }\n    },\n    computed: {\n        ...mapGetters('project', [\n            'projects',\n            'previewRouterName'\n        ])\n    },\n    watch: {},\n    beforeDestroy() {\n        window.$importImage.importByDevTool = null\n    },\n    mounted() {\n        window.$importImage.importByDevTool = (path) => {\n            this.onConfirmImportClick(path)\n        }\n    },\n    methods: {\n        async onConfirmImportClick(inputImportDir) {\n            const dirPath = this.inputImportDir || inputImportDir\n            if (!dirPath) {\n                this.tsNotify('路径不能为空')\n                return\n            }\n            try {\n                const ret = await fs.existsSync(dirPath)\n                if (!ret) {\n                    this.tsNotify('文件或文件夹不存在')\n                    return\n                }\n            } catch (e) {\n                this.tsNotify('文件或文件夹不存在')\n                return\n            }\n            this.processImport([dirPath])\n        },\n\n        processImport: debounce(async function(filePaths) {\n            const checkRet = await this.hasReadWritePermission(filePaths)\n            if (checkRet.result !== 1) {\n                this.toastNoReadWritePermission(checkRet)\n                return\n            }\n\n            if (filePaths.length > 0) {\n                let isAppend = false\n                let that = this\n                await this.checkAndImportImages(filePaths, isAppend, (otherImageFiles) => {\n                    that.$router.push({\n                        name: this.previewRouterName,\n                        query: {\n                            'imageFilePaths': otherImageFiles\n                        }\n                    })\n                }, progress => {\n                    if (progress.status === ImportProgressStatus.Start) {\n                        this.showImportProgress = true\n                    }\n                    this.importProgress = progress\n                })\n            }\n        }, 1000),\n\n\t\tonAddClick :debounce(async function (properties = ['openDirectory', 'openFile']) {\n\t\t\tif (this.isShowingImportDialog){\n\t\t\t\treturn\n\t\t\t}\n\t\t\tthis.isShowingImportDialog  = true\n            const dialog = dialogIpc\n            const result = await dialog.showOpenDialog({\n                properties: properties\n            })\n            if (result && result.filePaths && result.filePaths.length == 0) {\n\t\t\t\tthis.isShowingImportDialog = false\n                return\n            }\n\n            await this.processImport(result.filePaths)\n\t\t\tthis.isShowingImportDialog  = false\n\t\t},300),\n\n        // 创建工程的缩略图\n        async onDropHanlder(e) {\n            let files = this.getDropPaths()\n            let paths = []\n            for (let file of files) {\n                let fp = file.path\n                paths.push(fp)\n            }\n\n            const checkRet = await this.hasReadWritePermission(paths)\n            if (checkRet.result !== 1) {\n                this.toastNoReadWritePermission(checkRet)\n                return\n            }\n            let isAppend = false\n            await this.checkAndImportImages(paths, isAppend, (otherImageFiles) => {\n                this.$router.push({\n                    name: this.previewRouterName,\n                    query: {\n                        'imageFilePaths': otherImageFiles\n                    }\n                })\n            }, progress => {\n                if (progress.status === ImportProgressStatus.Start) {\n                    this.showImportProgress = true\n                }\n                this.importProgress = progress\n            })\n        }\n    }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.claImportRoot {\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    flex: 1;\n\n    .claImportContent {\n        width: 164px;\n        height: 164px;\n        border-width: 1px;\n        border-style: dashed;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        align-items: center;\n        border-radius: 8px;\n\n        /deep/ .el-button {\n            .el-icon-plus {\n                font-size: 24px;\n            }\n        }\n    }\n\n    .win-btn-class {\n        display: flex;\n        flex-direction: column;\n\n        .btn {\n            height: 48px;\n            line-height: 48px;\n            padding: 0;\n            width: 204px;\n            margin-bottom: 10px;\n            border-radius: 8px;\n\n            &:first-child {\n                margin-bottom: 24px;\n            }\n\n            .content {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n\n                .img {\n                    height: 20px;\n                    width: 20px;\n                    margin-right: 8px;\n                }\n\n                .text {\n                    display: inline-block;\n                    width: 70px;\n                    font-size: 14px;\n                    text-align: left;\n                }\n            }\n        }\n    }\n\n    .claDes {\n        font-size: 14px;\n        text-align: center;\n        margin-top: 38px;\n\n        margin-bottom: 50px;\n    }\n}\n</style>\n","import mod from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportImageView.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportImageView.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./ImportImageView.vue?vue&type=template&id=7d5e32cb&scoped=true&\"\nimport script from \"./ImportImageView.vue?vue&type=script&lang=js&\"\nexport * from \"./ImportImageView.vue?vue&type=script&lang=js&\"\nimport style0 from \"./ImportImageView.vue?vue&type=style&index=0&id=7d5e32cb&prod&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"7d5e32cb\",\n  null\n  \n)\n\nexport default component.exports","var render = function render(){var _vm=this,_c=_vm._self._c,_setup=_vm._self._setupProxy;return _c('el-dialog',{attrs:{\"top\":\"40vh\",\"width\":\"370px\",\"align\":\"center\",\"title\":\"\",\"custom-class\":\"common-dialog import-progress-dialog\",\"visible\":_vm.visible,\"close-on-click-modal\":false,\"close-on-press-escape\":false,\"show-close\":false},on:{\"update:visible\":function($event){_vm.visible=$event}}},[_c('div',{staticClass:\"container\"},[_c('div',{staticClass:\"info\"},[_vm._v(_vm._s(_vm.message))]),_c('div',{staticClass:\"claProgressItem\"},[_c('el-progress',{attrs:{\"show-text\":false,\"text-inside\":\"\",\"stroke-width\":5,\"percentage\":_vm.percentage > 100?100:_vm.percentage}}),(_vm.showCancelBtn && _vm.canShowCancelBtn)?_c('el-button',{staticClass:\"claCloseBtn\",attrs:{\"icon\":\"el-icon-close\"},on:{\"click\":_vm.onCancelClick}}):_vm._e()],1)])])\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\n    <el-dialog\n        top=\"40vh\"\n        width=\"370px\"\n        align=\"center\"\n        title=\"\"\n        custom-class=\"common-dialog import-progress-dialog\"\n        :visible.sync=\"visible\"\n        :close-on-click-modal=\"false\"\n        :close-on-press-escape=\"false\"\n        :show-close=\"false\"\n    >\n        <div class=\"container\">\n            <div class=\"info\">{{ message }}</div>\n            <div class=\"claProgressItem\">\n                <el-progress\n                    :show-text=\"false\"\n                    text-inside\n                    :stroke-width=\"5\"\n                    :percentage=\"percentage > 100?100:percentage\"\n                />\n\n                <el-button\n                    v-if=\"showCancelBtn && canShowCancelBtn\"\n                    icon=\"el-icon-close\"\n                    class=\"claCloseBtn\"\n                    @click=\"onCancelClick\">\n                </el-button>\n            </div>\n        </div>\n    </el-dialog>\n</template>\n\n<script>\n\nimport { defineComponent } from 'vue'\nimport { mapGetters, mapMutations } from 'vuex'\nimport toast from '@/mixins/toast'\nimport { ImportProgressStatus } from '@/constants'\n\nimport { Dialog, Progress } from 'element-ui'\nimport { delay } from '@/universal/utils/common'\nimport NodeApi from '@/qt-ipc/node-api'\nimport TsDialog from '@/components/TsDialog/ts-dialog'\nimport useHomeItemPointsRepositories from '@/composables/points/useHomeItemPointsRepositories'\n\nconst path = NodeApi.path\nconst process = require('process')\n\nexport default defineComponent({\n    name: 'import-progress-dialog',\n    mixins: [toast],\n    components: {\n        'el-dialog': TsDialog,\n        'el-progress': Progress,\n\n    },\n    props: {\n        value: {\n            type: Boolean,\n            default: false\n        },\n        status: {\n            type: String,\n            default: ImportProgressStatus.Start\n        },\n        data: {\n            type: Object,\n            default: () => {\n            }\n        },\n        // 导入的文件路径列表\n        importFilePaths: {\n            type: Array,\n            default: () => {\n                return []\n            }\n        },\n        showCancelBtn: {\n            type: Boolean,\n            default: true\n        },\n        importName:{\n            type: String,\n            default: \"\"\n        }\n    },\n    setup() {\n        const { PointHomeItem } = useHomeItemPointsRepositories()\n\n        return {\n            PointHomeItem\n        }\n    },\n    data() {\n        return {\n            loading: false,\n            visible: this.value,\n            loadingTimer: null,\n            uploadPercent: 0,\n            isCancel: false,\n            canShowCancelBtn: true,\n            hasImportDbStatus: false\n        }\n    },\n    filters: {},\n    computed: {\n        ...mapGetters('finishing', []),\n        // 计算文本的像素宽度\n        ...mapGetters('thumbnail', [\n            'cancelImport'\n        ]),\n        message() {\n            let name = this.importName\n            const maxTextPixLen = 312\n            const strTemplateMsg = '正在导入${n}下选择的图片'\n            const strFixMsg = strTemplateMsg.replace('${n}', '')\n            const innerMaxTextPixLen = maxTextPixLen - this.calcTextPixLen(strFixMsg)\n            const namePixLen = this.calcTextPixLen(name)\n\n            if (name && namePixLen > innerMaxTextPixLen) {\n                const nameLen = name.length\n                const lastLen = 10\n                const strLastTen = name.substr(name.length - lastLen, lastLen)\n                const lastTenPixLen = this.calcTextPixLen(strLastTen)\n                const aPixLen = namePixLen / nameLen\n                let preLen = (innerMaxTextPixLen - aPixLen * 2 - lastTenPixLen)\n                let strPrefix = ''\n                for (let i = 0; i < nameLen; i++) {\n                    strPrefix += name[i]\n                    const nextPixLen = this.calcTextPixLen(strPrefix)\n                    if (nextPixLen > preLen) {\n                        break\n                    }\n                }\n                name = `${strPrefix}...${strLastTen}`\n            }\n            let strMsg = `正在导入选择的图片`\n            if (name) {\n                strMsg = strTemplateMsg.replace('${n}', name)\n            }\n            if (this.status == ImportProgressStatus.ImportingToDB || this.hasImportDbStatus) {\n                strMsg = `正在载入数据库，请稍后…`\n            }\n\n            return strMsg\n        },\n        formatMessage(strInput) {\n            return strInput\n        },\n        percentage() {\n            const actions = {\n                [ImportProgressStatus.Start]: 2,\n                [ImportProgressStatus.ImportOver]: 100,\n                [ImportProgressStatus.CancelImport]: 19,\n                [ImportProgressStatus.ImportEmpty]: 39,\n                [ImportProgressStatus.RequestZeroError]: 31\n            }\n\n            if (this.status === ImportProgressStatus.Start || this.status === ImportProgressStatus.Importing) {\n                const { over, total } = this.data\n                if (over === undefined || total === undefined) {\n                    return 0\n                }\n                const per = over / total * 100\n                let progress = parseInt(per)\n\n                console.log('per : ', progress, ' status : ', this.status)\n                return progress\n            }\n\n            if (this.status === ImportProgressStatus.Start) {\n                let begin = actions[ImportProgressStatus.Start]\n                const { over, total } = this.data\n                const per = over / total\n                begin += parseInt(40 * per)\n                return this.uploadPercent + begin\n            } else if (this.status === ImportProgressStatus.RequestZero) {\n                return this.uploadPercent + 2\n            } else if (this.status === ImportProgressStatus.Importing) {\n                const { over, total } = this.data\n                const per = over / total\n                return 40 + parseInt(60 * per)\n            } else {\n                return actions[this.status] || 0\n            }\n        }\n    },\n    watch: {\n        value: {\n            handler(val) {\n                this.visible = val\n            },\n            immediate: true\n        },\n        visible(val) {\n            if (!val) {\n                this.hasImportDbStatus = false\n            }\n            this.$emit('input', val)\n        },\n        status(val) {\n            if (val == ImportProgressStatus.ImportingToDB) {\n                this.canShowCancelBtn = false\n                this.hasImportDbStatus = true\n            }\n            const closes = [\n                ImportProgressStatus.ImportOver,\n                ImportProgressStatus.CancelImport,\n                ImportProgressStatus.ImportEmpty,\n                ImportProgressStatus.ImportRepet,\n                ImportProgressStatus.RequestZeroError\n            ]\n            if (val === ImportProgressStatus.RequestZero) {\n                this.autoAddPercentage()\n            } else {\n                clearTimeout(this.loadingTimer)\n                if (closes.includes(val)) {\n                    delay(val === ImportProgressStatus.ImportOver ? 300 : 1000).then(() => {\n                        this.visible = false\n                    })\n                }\n            }\n        }\n    },\n    mounted() {\n    },\n    methods: {\n        ...mapMutations([]),\n        async getInputRootName() {\n            console.log(`getInputRootName`, process)\n            const strHome = process.env.HOME || process.env.USERPROFILE || process.env.HOMEPATH\n            const filePaths = this.importFilePaths\n            const rootSysDisk = await path.parse(strHome).root.toUpperCase()\n\n            const winSysDefDir = [\n                strHome,\n                await path.join(rootSysDisk, '/Public')\n            ]\n            const macSysDefDir = [\n                '/Applications',\n                '/Users/Shared',\n                strHome\n            ]\n\n            const groupRootPathByPath = async (inputFilePaths) => {\n                const groupMap = new Map()\n                for (const inputFilePath of inputFilePaths) {\n                    let curSysDefDir = this.$isWin ? winSysDefDir : macSysDefDir\n                    let foundKey = null\n                    for (const it of curSysDefDir) {\n                        if (inputFilePath.startsWith(it)) {\n                            foundKey = it\n                            break\n                        }\n                    }\n                    if (foundKey) {\n                        let foundItem = groupMap.get(foundKey)\n                        if (!foundItem) {\n                            foundItem = []\n                        }\n                        foundItem.push(inputFilePath)\n                        groupMap.set(foundKey, foundItem)\n                    }\n\n                    if (this.$isWin) { // 如果是win,没找到，则可能是其他盘符\n                        if (!foundKey) {\n                            const rootDisk = await path.parse(inputFilePath).root.toUpperCase()\n                            groupMap.set(rootDisk, inputFilePath)\n                        }\n                    }\n                }\n                return groupMap\n            }\n\n            const filterGroup = groupRootPathByPath(filePaths)\n            const groupSize = filterGroup.size\n            let name = null\n            if (groupSize === 1) { // 找不到特定的约定的目录，则归为others\n                name = filterGroup.keys().next().value\n                if (name.startsWith(strHome)) { // 是家目录下面的，要区分具体的名称\n                    const dstList = filterGroup.get(name)\n                    const firstItem = dstList[0]\n                    const sep = await path.sep()\n                    const fHome = await path.join(strHome, sep)\n                    const beginIndex = fHome.length\n                    let firstDirPath = fHome\n                    for (let i = beginIndex; i < firstItem.length; i++) {\n                        const a = firstItem[i]\n                        if (a === sep) {\n                            break\n                        }\n                        firstDirPath += a\n                    }\n                    let isFound = true\n                    for (const nextItem of dstList) {\n                        if (!nextItem.startsWith(firstDirPath)) {\n                            isFound = false\n                            break\n                        }\n                    }\n                    name = isFound ? firstDirPath : null\n                }\n            }\n            if (!name) {\n                return null\n            }\n            let retName = await path.basename(name)\n            if (!retName || retName.length === 0) {\n                retName = name\n            }\n            return retName\n        },\n        calcTextPixLen(text) {\n            let result = 0\n\n            let ele = document.createElement('span')\n            //字符串中带有换行符时，会被自动转换成<br/>标签，若需要考虑这种情况，可以替换成空格，以获取正确的宽度\n            //str = str.replace(/\\\\n/g,' ').replace(/\\\\r/g,' ');\n            ele.innerText = text\n            //不同的大小和不同的字体都会导致渲染出来的字符串宽度变化，可以传入尽可能完备的样式信息\n            ele.style.fontSize = '14px'\n            ele.style.fontWeight = 'normal'\n\n            //由于父节点的样式会影响子节点，这里可按需添加到指定节点上\n            document.documentElement.append(ele)\n\n            result = ele.offsetWidth\n            document.documentElement.removeChild(ele)\n            return result\n        },\n        autoAddPercentage() {\n            console.log('autoAddPercentage')\n            if (this.status === ImportProgressStatus.CancelImport || !this.visible || this.cancelImport) {\n                clearTimeout(this.loadingTimer)\n                this.loadingTimer = null\n                console.log(`kill autoAddPercentage()`)\n                return\n            }\n            if (this.loadingTimer) clearTimeout(this.loadingTimer)\n            this.loadingTimer = setTimeout(_ => {\n                if (this.status === ImportProgressStatus.CancelImport || !this.visible || this.cancelImport) {\n                    clearTimeout(this.loadingTimer)\n                    this.loadingTimer = null\n                    console.log(`kill autoAddPercentage()`)\n                    return\n                }\n                if (this.uploadPercent < 38) {\n                    this.uploadPercent += 1\n                    this.autoAddPercentage()\n                }\n            }, 100)\n        },\n        onCancelClick() {\n            this.PointHomeItem(\"import_close\")\n            this.$emit('onCancelled', null)\n        }\n    }\n})\n</script>\n\n<style lang=\"scss\">\n.import-progress-dialog {\n    .el-dialog__header {\n        display: none;\n    }\n\n    .el-dialog__body {\n        padding: 40px 28px !important;\n    }\n}\n</style>\n\n<style lang=\"scss\" scoped>\n.import-progress-dialog {\n    /deep/ {\n        .el-dialog__header {\n            display: none;\n        }\n\n        .el-dialog__body {\n            padding: 40px 28px;\n        }\n    }\n\n    .container {\n        text-align: left;\n        color: #D9D9D9;\n\n        .info {\n            margin-bottom: 8px;\n        }\n\n        .claProgressItem {\n            display: flex;\n            flex-direction: row;\n            align-items: center;\n\n            .claCloseBtn {\n                background: #4E4E4E;\n                width: 18px;\n                height: 18px;\n                border-radius: 9px;\n                padding: 0px;\n                flex-shrink: 1;\n            }\n\n            /deep/ .el-progress {\n                flex: 1;\n                margin-right: 12px;\n                font-size: 14px;\n            }\n        }\n    }\n}\n\n</style>\n","import mod from \"-!../../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../../node_modules/thread-loader/dist/cjs.js!../../../../node_modules/babel-loader/lib/index.js!../../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportProgressDialog.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../../node_modules/thread-loader/dist/cjs.js!../../../../node_modules/babel-loader/lib/index.js!../../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportProgressDialog.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./ImportProgressDialog.vue?vue&type=template&id=193bb274&scoped=true&\"\nimport script from \"./ImportProgressDialog.vue?vue&type=script&lang=js&\"\nexport * from \"./ImportProgressDialog.vue?vue&type=script&lang=js&\"\nimport style0 from \"./ImportProgressDialog.vue?vue&type=style&index=0&id=193bb274&prod&lang=scss&\"\nimport style1 from \"./ImportProgressDialog.vue?vue&type=style&index=1&id=193bb274&prod&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"193bb274\",\n  null\n  \n)\n\nexport default component.exports","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--9-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--9-oneOf-1-1!../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--9-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--9-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportImageView.vue?vue&type=style&index=0&id=7d5e32cb&prod&lang=scss&scoped=true&\"","export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--9-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--9-oneOf-1-1!../../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--9-oneOf-1-2!../../../../node_modules/sass-loader/dist/cjs.js??ref--9-oneOf-1-3!../../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportProgressDialog.vue?vue&type=style&index=1&id=193bb274&prod&lang=scss&scoped=true&\"","export * from \"-!../../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--9-oneOf-1-0!../../../../node_modules/css-loader/dist/cjs.js??ref--9-oneOf-1-1!../../../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../../../node_modules/postcss-loader/src/index.js??ref--9-oneOf-1-2!../../../../node_modules/sass-loader/dist/cjs.js??ref--9-oneOf-1-3!../../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./ImportProgressDialog.vue?vue&type=style&index=0&id=193bb274&prod&lang=scss&\"","import useBaseRepositories from './useBaseRepositories'\nimport { PointEvent } from '@/constants/pointsDef'\n\ninterface IUseUpdatePointsRepositories {\n    PointHomeItem: (operate: string) => void\n    PointClickProject: (itemCount: number) => void\n}\n\nexport default function useHomeItemPointsRepositories(): IUseUpdatePointsRepositories {\n    const { sendPoint } = useBaseRepositories()\n\n    function PointHomeItem(operate: string) {\n        sendPoint(PointEvent.CakeWorkBench, { cake_operate: operate })\n    }\n\n    function PointClickProject(itemCount: number) {\n        sendPoint(PointEvent.CakeWorkBench, { cake_operate: 'click_project', cake_number: itemCount })\n    }\n\n    return {\n        PointHomeItem,\n        PointClickProject\n    }\n}\n"],"sourceRoot":""}